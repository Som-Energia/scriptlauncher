<!doctype html>
<html>
<head>
    <title>Ejecutando {{description}}</title>
    <style>
        {{style}}
        .ansi_terminal {
            padding: 2em;
            border: 2pt #489 solid;
            overflow: auto;
            overflow-y: hidden;
        }
        .commandline {
            padding: 1ex;
            background: #DDD;
        }
        .links {
            padding: 1ex;
        }
        .return_code {
            padding: 1ex;
        }
        .param_name {
            padding: 1ex;
        }
        .loading { margin: auto; }
        
        .uploading_file {
            display: none;
            color: red;
        }

        .loading span {
          line-height: 32px;
          margin-left: 12px;
          font-size: 16px;
          vertical-align: middle;
        }

        .loading img { vertical-align: middle; }

        .loading_wrp {
          background-color: #FFF;
          display: block;
          height: 100%;
          left: 0;
          opacity: 0.5;
          filter: alpha(opacity=50);
          position: absolute;
          top: 0;
          width: 100%;
          z-index: 1020;
        }

        .loading_wrp .x16 span {
          line-height: 16px;
          font-size: 12px;
          margin-left: 6px;
        }

        .loading_wrp .x32 img {
          width: 32px;
          height: 32px;
        }

    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <script src="{{url_for('static', filename='jquery.filedrop.js')}}"></script>
    <script src="{{url_for('static', filename='upload.js')}}"></script>
    <script src="{{url_for('static', filename='jquery-loader.js')}}"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>{{name}}</h1>
    <h2>{{description}}</h2>
    {% if fileparameter is defined %}
        <form id="upload-file" method="post" enctype="multipart/form-data">
            <fieldset>
                <label for="{{fileparameter.name}}" class="parm_name">{{fileparameter.description}}</label>
                <input type=file name={{fileparameter.name}}>
            </fieldset>
            <fieldset>
                <button id="upload-file-btn" type="button">Upload</button>
            </fieldset>
        </form>
        <div id="uploading-file" class="uploading_file">Loading...</div>
    {% endif %}
    <form name="runner" id="runner">
        {% if fileparameter is defined %}
            <input type="hidden" name="filename" value="{{fileparameter.name}}"></input>
        {% endif %}
        {% if parameters is defined %}
            {% for paramname,parameter in parameters.items() if 'userdescription' in parameter %}
                <div><label for="{{paramname}}" class="param_name">{{parameter.userdescription}}</label><input name="{{paramname}}"/></div>
            {% endfor %}
        {% endif %}
        <input type="submit" value="Ejecutar"/>
    </form>
    <div class="commandline"><tt>{{script}}</tt></div>
    <div id="result" class="ansi_terminal"></div>
    <div id="index-link" class="links"><a href="/">Index</a></div>
    Return code:<div id="return-code" class="return_code"></div>
<script type="text/javascript">
$(document).ready(function(){
    console.log("defining");
    $("#runner").submit(function(e) {
        console.log("Submiting");
        $("#result").css("border-color","#489");
        $("#uploading-file").css("display","none");
        $("#runner").loader({
            imgUrl: "{{ url_for('static', filename='loading32x32.gif') }}"
        });
        $.post(
             "/run/{{name}}",
             $(this).serialize(),
             function(data) {
                 console.log("Success");
                 var response= jQuery.parseJSON(data);
                 $("#result").html(response.response);
                 $("#return-code").html(response.return_code);
                 if (response.return_code<0) {
                     $("#result").css("border-color","#C80000");
                 }
                 $.loader.close();
                 }
             );
        e.preventDefault();
    });
    $('#upload-file-btn').click(function() {
        var form_data = new FormData($('#upload-file')[0]);
        $("#upload-file").loader({
            imgUrl: "{{ url_for('static', filename='loading32x32.gif') }}"
        });
        $("#uploading-file").css("display","block");
        $("#uploading-file").css("color","red");
        $("#uploading-file").html("Loading...");
        $.ajax({
            type: 'POST',
            url: '/upload',
            data: form_data,
            contentType: false,
            cache: false,
            processData: false,
            async: false,
            success: function(data) {
                console.log('Success file uploading!');
                $("#uploading-file").css("color","green");
                $("#uploading-file").html("Loaded!");
                $.loader.close();
            },
        });
    });
});
</script>
</body>
</html>

